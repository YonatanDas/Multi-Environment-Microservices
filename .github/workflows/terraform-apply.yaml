name: Terraform Apply

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to apply'
        required: true
        type: choice
        options:
          - dev
          - stag
          - prod
      terraform_version:
        description: 'Terraform version'
        required: false
        default: '1.6.0'
      auto_approve:
        description: 'Auto approve (dev only)'
        required: false
        type: boolean
        default: false

concurrency:
  group: terraform-apply-${{ github.ref }}-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: ${{ github.event.inputs.terraform_version || '1.6.0' }}
  TF_STATE_BUCKET: banking-terraform-state-18.10.25
  TF_LOCK_TABLE: terraform-locks
  AWS_ROLE: github-actions-terraform-role
  Artifacts_S3_Bucket: my-ci-artifacts55
  Artifacts_S3_Prefix: cloud-infrastructure
  Artifacts_Folder: collected-artifacts
  WORKFLOW_NAME: terraform-apply


jobs:
  terraform-apply-dev:
    name: Apply to Dev
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/test-workflows' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment: dev
    outputs:
      apply-status: ${{ steps.apply.outputs.status }}
      resources-created: ${{ steps.summary.outputs.resources-created }}
      resources-updated: ${{ steps.summary.outputs.resources-updated }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setting up env
        uses: actions/checkout@v3
      - name: Setup AWS + ECR
        uses: ./.github/actions/env-setup
        with:
          aws_role: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE }}
          aws_region: ${{ env.AWS_REGION }}
          registry: ${{ env.REGISTRY }}

      - name: Download plan artifact (if available)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: tfplan-dev
          path: terraform/environments/dev/

      - name: Initialize Terraform
        working-directory: terraform/environments/dev
        run: terraform init

      - name: Validate Terraform
        working-directory: terraform/environments/dev
        run: terraform validate

      - name: Run plan verification
        id: plan-verify
        working-directory: terraform/environments/dev
        run: |
          terraform plan -var-file=dev.tfvars -no-color | tee plan-verification.txt
        continue-on-error: true

      - name: Apply Terraform
        id: apply
        working-directory: terraform/environments/dev
        run: |
          if [ -f "tfplan-dev.bin" ]; then
            terraform apply tfplan-dev.bin -no-color | tee apply-output.txt
          else
            terraform apply -var-file=dev.tfvars -auto-approve -no-color | tee apply-output.txt
          fi
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Get Terraform outputs
        working-directory: terraform/environments/dev
        run: terraform output -json > terraform-output-dev.json
        continue-on-error: true

      - name: Generate apply summary
        id: summary
        working-directory: terraform/environments/dev
        run: |
          echo "## Terraform Apply Results for dev" > apply-summary-dev.txt
          echo "" >> apply-summary-dev.txt
          echo "### Status: ${{ steps.apply.outputs.status }}" >> apply-summary-dev.txt
          echo "" >> apply-summary-dev.txt
          echo "### Apply Output" >> apply-summary-dev.txt
          echo "<details>" >> apply-summary-dev.txt
          echo "<summary>Click to expand apply output</summary>" >> apply-summary-dev.txt
          echo "" >> apply-summary-dev.txt
          echo "\`\`\`" >> apply-summary-dev.txt
          cat apply-output.txt >> apply-summary-dev.txt 2>&1 || echo "No apply output available"
          echo "\`\`\`" >> apply-summary-dev.txt
          echo "" >> apply-summary-dev.txt
          echo "</details>" >> apply-summary-dev.txt
          echo "resources-created=0" >> $GITHUB_OUTPUT
          echo "resources-updated=0" >> $GITHUB_OUTPUT

      - name: Upload apply logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apply-logs-dev
          path: |
            terraform/environments/dev/apply-output.txt
            terraform/environments/dev/terraform-output-dev.json
          retention-days: 30

      - name: Post apply status
        if: always()
        run: |
          if [ "${{ steps.apply.outputs.status }}" == "success" ]; then
            echo "✅ Terraform apply to dev completed successfully"
          else
            echo "❌ Terraform apply to dev failed"
            exit 1
          fi

  terraform-apply-stag:
    name: Apply to Staging
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'stag'
    environment: stag
    outputs:
      apply-status: ${{ steps.apply.outputs.status }}
      resources-created: ${{ steps.summary.outputs.resources-created }}
      resources-updated: ${{ steps.summary.outputs.resources-updated }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setting up env
        uses: actions/checkout@v3
      - name: Setup AWS + ECR
        uses: ./.github/actions/env-setup
        with:
          aws_role: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE }}
          aws_region: ${{ env.AWS_REGION }}
          registry: ${{ env.REGISTRY }}

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-stag
          path: terraform/environments/stag/
        continue-on-error: true

      - name: Check plan file exists
        working-directory: terraform/environments/stag
        run: |
          if [ ! -f "tfplan-stag.bin" ]; then
            echo "❌ Plan file not found. Please run the plan workflow first."
            exit 1
          fi
          echo "✅ Plan file found"

      - name: Initialize Terraform
        working-directory: terraform/environments/stag
        run: terraform init

      - name: Validate Terraform
        working-directory: terraform/environments/stag
        run: terraform validate

      - name: Show plan output
        working-directory: terraform/environments/stag
        run: terraform show tfplan-stag

      - name: Apply Terraform
        id: apply
        working-directory: terraform/environments/stag
        run: |
          terraform apply tfplan-stag.bin -no-color | tee apply-output.txt
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Get Terraform outputs
        working-directory: terraform/environments/stag
        run: terraform output -json > terraform-output-stag.json
        continue-on-error: true

      - name: Generate apply summary
        id: summary
        working-directory: terraform/environments/stag
        run: |
          echo "## Terraform Apply Results for stag" > apply-summary-stag.txt
          echo "" >> apply-summary-stag.txt
          echo "### Status: ${{ steps.apply.outputs.status }}" >> apply-summary-stag.txt
          echo "" >> apply-summary-stag.txt
          echo "### Apply Output" >> apply-summary-stag.txt
          echo "<details>" >> apply-summary-stag.txt
          echo "<summary>Click to expand apply output</summary>" >> apply-summary-stag.txt
          echo "" >> apply-summary-stag.txt
          echo "\`\`\`" >> apply-summary-stag.txt
          cat apply-output.txt >> apply-summary-stag.txt 2>&1 || echo "No apply output available"
          echo "\`\`\`" >> apply-summary-stag.txt
          echo "" >> apply-summary-stag.txt
          echo "</details>" >> apply-summary-stag.txt
          echo "resources-created=0" >> $GITHUB_OUTPUT
          echo "resources-updated=0" >> $GITHUB_OUTPUT

      - name: Upload apply logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apply-logs-stag
          path: |
            terraform/environments/stag/apply-output.txt
            terraform/environments/stag/apply-summary-stag.txt
            terraform/environments/stag/terraform-output-stag.json
          retention-days: 30

      - name: Post apply status
        if: always()
        run: |
          if [ "${{ steps.apply.outputs.status }}" == "success" ]; then
            echo "✅ Terraform apply to staging completed successfully"
          else
            echo "❌ Terraform apply to staging failed"
            exit 1
          fi

  terraform-apply-prod:
    name: Apply to Production
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment: prod
    outputs:
      apply-status: ${{ steps.apply.outputs.status }}
      resources-created: ${{ steps.summary.outputs.resources-created }}
      resources-updated: ${{ steps.summary.outputs.resources-updated }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify branch protection
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "❌ Production deployments are only allowed from main branch"
            exit 1
          fi
          echo "✅ Branch protection verified"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.GITHUB_ACTIONS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-prod
          path: terraform/environments/prod/
        continue-on-error: true

      - name: Check plan file exists
        working-directory: terraform/environments/prod
        run: |
          if [ ! -f "tfplan-prod.bin" ]; then
            echo "❌ Plan file not found. Please run the plan workflow first."
            exit 1
          fi
          echo "✅ Plan file found"

      - name: Initialize Terraform
        working-directory: terraform/environments/prod
        run: terraform init

      - name: Validate Terraform
        working-directory: terraform/environments/prod
        run: terraform validate

      - name: Show plan output
        working-directory: terraform/environments/prod
        run: terraform show tfplan-prod

      - name: Apply Terraform
        id: apply
        working-directory: terraform/environments/prod
        run: |
          terraform apply tfplan-prod.bin -no-color | tee apply-output.txt
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Get Terraform outputs
        working-directory: terraform/environments/prod
        run: terraform output -json > terraform-output-prod.json
        continue-on-error: true

      - name: Generate apply summary
        id: summary
        working-directory: terraform/environments/prod
        run: |
          echo "## Terraform Apply Results for prod" > apply-summary-prod.txt
          echo "" >> apply-summary-prod.txt
          echo "### Status: ${{ steps.apply.outputs.status }}" >> apply-summary-prod.txt
          echo "" >> apply-summary-prod.txt
          echo "### Apply Output" >> apply-summary-prod.txt
          echo "<details>" >> apply-summary-prod.txt
          echo "<summary>Click to expand apply output</summary>" >> apply-summary-prod.txt
          echo "" >> apply-summary-prod.txt
          echo "\`\`\`" >> apply-summary-prod.txt
          cat apply-output.txt >> apply-summary-prod.txt 2>&1 || echo "No apply output available"
          echo "\`\`\`" >> apply-summary-prod.txt
          echo "" >> apply-summary-prod.txt
          echo "</details>" >> apply-summary-prod.txt
          echo "resources-created=0" >> $GITHUB_OUTPUT
          echo "resources-updated=0" >> $GITHUB_OUTPUT

      - name: Upload apply logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: apply-logs-prod
          path: |
            terraform/environments/prod/apply-output.txt
            terraform/environments/prod/apply-summary-prod.txt
            terraform/environments/prod/terraform-output-prod.json
          retention-days: 30

      - name: Create deployment tag
        if: steps.apply.outputs.status == 'success'
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "terraform-prod-${TIMESTAMP}" -m "Terraform apply to prod - ${TIMESTAMP}"
          git push origin "terraform-prod-${TIMESTAMP}"

      - name: Post apply status
        if: always()
        run: |
          if [ "${{ steps.apply.outputs.status }}" == "success" ]; then
            echo "✅ Terraform apply to production completed successfully"
          else
            echo "❌ Terraform apply to production failed"
            exit 1
          fi
 
  Collect-Artifacts:
    runs-on: ubuntu-latest
    needs: [terraform-apply-dev, terraform-apply-stag, terraform-apply-prod]
    steps:
      - uses: actions/checkout@v3
      - name: Setup AWS + ECR
        uses: ./.github/actions/env-setup
        with:
          aws_role: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ env.AWS_ROLE }}
          aws_region: ${{ env.AWS_REGION }}
          registry: ${{ env.REGISTRY }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: collected-artifacts/
      - name: Upload to S3
        run: ./.github/scripts/08-artifact_collect_and_s3.sh ${{ env.Artifacts_S3_Bucket}} ${{ env.Artifacts_S3_Prefix}} ${{ env.Artifacts_Folder}} ${{ env.WORKFLOW_NAME}}
