apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-cosign-signature
  annotations:
    policies.kyverno.io/title: Require Cosign Image Signatures
    policies.kyverno.io/category: Image Verification
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod,Deployment,StatefulSet,DaemonSet,Job,CronJob
    policies.kyverno.io/description: >-
      Ensures all container images are signed with Cosign using GitHub Actions
      keyless signing before deployment. This prevents deployment of unsigned
      or tampered images, maintaining supply chain security.
      Images must be signed via GitHub Actions workflow with OIDC issuer
      'https://token.actions.githubusercontent.com'.
spec:
  validationFailureAction: Enforce
  background: true
  rules:
    - name: verify-image-signature
      match:
        any:
          - resources:
              kinds:
                - Pod
                - Deployment
                - StatefulSet
                - DaemonSet
                - Job
                - CronJob
      verifyImages:
        - imageReferences:
            - "063630846340.dkr.ecr.us-east-1.amazonaws.com/*"
          attestors:
            - count: 1
              entries:
                - keyless:
                    # Match GitHub Actions workflow from this repository
                    # Subject format: https://github.com/<org>/<repo>/.github/workflows/<workflow>@refs/heads/<branch>
                    subject: "https://github.com/YonatanDas/Banking-Microservices-Platform/.github/workflows/Microservice-Ci.yaml@refs/heads/main"
                    issuer: "https://token.actions.githubusercontent.com"
                    rekor:
                      url: https://rekor.sigstore.dev
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kyverno
                - argocd
                - external-secrets
                - monitoring